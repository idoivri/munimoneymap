
<!DOCTYPE html>
<html>
<head>
	<title>Israeli Municipal Tax (Arnona) Map</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- 	<link rel="stylesheet" href="dist/leaflet.css" />
	<script src="dist/leaflet.js"></script> -->

	<!--bootstrap css -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

	<script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
	<link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />

	<link rel="stylesheet" href="css/style.css" />

	<!--jquery js-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<!--bootstrap js -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

	<script src="dist/papaparse.min.js"></script>
<!-- 	 <script src="dist/PruneCluster.js"></script> -->
	<!--
	<script src="http://code.jquery.com/jquery-1.8.2.js"></script>
	<script src="http://jquery-csv.googlecode.com/git/src/jquery.csv.js"></script>
	-->

</head>
<body>


	<!-- <div id="header-wrap">
    	<h3>מפת הארנונה</h3>
  		
	</div> -->
	<div id='legend' style='display:none;'>
	  <div class='legend-title'>
	  	<strong>מפת הארנונה</strong>
	  </div>
	  <nav class='legend clearfix'>
	  	<!-- http://colorbrewer2.org/ -->
	    <span style='background:#005824;'></span>
	    <span style='background:#fee5d9;'></span>
	    <span style='background:#fcbba1;'></span>
	    <span style='background:#fc9272;'></span>
	    <span style='background:#fb6a4a;'></span>
	    <span style='background:#de2d26;'></span>
	    <span style='background:#a50f15;'></span>
	    <label>ֿ0 &gt</label>
	    <label>&lt 5</label>
	    <label>&lt 10</label>
	    <label>&lt 15</label>
	    <label>&lt 20</label>
	    <label>&lt 25</label>
	    <label>+25</label>
	    <small>Source: <a href="#link to source">Yogev Sharvit</a></small>



	</div>
	<div id="map">
		 	<h1><span>מפת הארנונה</span></h1>

	</div>
		

	<script>


		var getDifferenceColor = function (d) {
			// console.log("got difference ",d);
		    return d < 0 ? '#005824' :
		           d < 5  ? '#fee5d9' :
		           d < 10  ? '#fcbba1' :
		           d < 15  ? '#fc9272' :
		           d < 20   ? '#fb6a4a' :
		           d < 25   ? '#de2d26' :
		                      '#a50f15';
		}

		// Provide your access token
		L.mapbox.accessToken = 'pk.eyJ1IjoiaWRvaXZyaSIsImEiOiJtSDZZd0dzIn0.AGwQs7X6LESuybqo6fUVpg#10';
		// Create a map in the div #map
		var map = L.mapbox.map('map', 'idoivri.061o0kcl').setView([32.06425, 34.769722], 9);
		
		map.legendControl.addLegend(document.getElementById('legend').innerHTML);		

	
		// function onLocationFound(e) {
		// 	var radius = e.accuracy / 2;

		// 	L.marker(e.latlng).addTo(map)
		// 		.bindPopup("אתם נמצאים " + radius + " מטרים מכאן").openPopup();

		// 	L.circle(e.latlng, radius).addTo(map);
		// }

		// function onLocationError(e) {
		// 	alert(e.message);
		// }

		// map.on('locationfound', onLocationFound);
		// map.on('locationerror', onLocationError);

		// map.locate({setView: true, maxZoom: 16});
		// //map.setView([31.782,35.21933], 16);

		


		Papa.parse("./data/munis-arnona.csv", {
			header: false,
			download: true,
			complete: function(results) {

				//console.log(results);
				var len = results.data.length;

				console.log(results.data[1]);

				for (var i=1; i<len; i++){
					//console.log(results.data[i]);
					line = results.data[i];





			        //console.log("COORDS: " + line[12] + "," + line[11]);
			        if (line[0]===undefined || line[0]==="") {
			        	console.log("No hebrew name for municipalitiy");	
			        }
			        else if (line[1]===undefined || line[1]==="") {
			        	console.log("No english name for municipality "+line[0]+", can't extract polygon!");
			        }
			        else if (line[7]===undefined || line[7]==="" || line[9]===undefined || line[9]==="") {
			        	console.log("No financial detail for "+line[0]);
			        }
			        else {

			        	name = line[1]; //url name relies 

			      //   	var layerStyle = {
								 //        fillColor: getDifferenceColor(line[line.length-1]),
								 //        color: 'black',
								 //        fillOpacity: 0.6,
									// };

						var urlString = 'http://cdn.rawgit.com/idoivri/israel-municipalities-polygons/master/'+name+'/'+name+'.geojson';


						var geoJsonLayerData;

						$.get(urlString, function(data) {
							//console.log("data:",data);
						  	geoJsonLayerData = data;

						  	if (!geoJsonLayerData) {
								console.log("did not get geoJsonLayerData!");
								return;
							}

								

							var geojsonLayer = new L.GeoJSON(geoJsonLayerData, {style: {
								fillColor: getDifferenceColor(line[14]),
								color: 'black',
								fillOpacity: 0.6}
							}); 

					        if (!geojsonLayer) {
					        	console.log("coulnd't create get layer for: "+layer[0]);
					        	return;
					        }

					        var content = "<b>"+line[0]+"</b><br/>"+
					        				"תעריף נורמטיבי למגורים: "+line[7]+"<br/>"+
					        				"תעריף בפועל: "+line[9]+"<br/>"+
					        				"<b>"+"הפרש התעריף בין המצוי לרצוי: "+line[14]+"</b><br/>"; 

					        geojsonLayer.bindPopup(content);

					        map.addLayer(geojsonLayer);

						});

						
				     //    else {
				     //    	var str = createPopUpStr(results.data[i]);	
					    //     var marker = new PruneCluster.Marker(lng, lat)
					    //     if (results.data[i][6]!==" " || results.data[i][7]!==" ") {
					    //     	marker.data.icon = myWheelChairIcon;
					    //     }
					    //     marker.data.popup= str;
					    //     //marker.setPopupContent(str)
					    //     pruneCluster.RegisterMarker(marker);

					    // }
					}
				}
				
			}
		});



		// function createPopUpStr(arr) {
		// 	console.log(arr);
		// 	str = "<div class=\"marker\">"
		// 	str += "<b>קלפי מספר:" + arr[4] + "</b><br/>";
		// 	str += "בנפה: " + arr[2] + "<br/>";
		// 	str += "כתובת: " + arr[0] + "<br/>";
		// 	str += "מיקום הקלפי: " + arr[5] + "<br/>";
		// 	if (arr[6]=="כ") {
		// 		str += "<b>קלפי נגישה ";
		// 		if (arr[7]=="כ") {
		// 			str+="מיוחדת";
		// 		} 
		// 		str +="</b><br/>";
		// 	}
			
		// 	/*str += "<a href=\"tel:"+arr[2]+"\">"+arr[2]+"</a><br/>";
		// 	if (arr[3]!="") {
		// 		str += "<a href=\"http://"+arr[3]+"\" target=\"_blank\">"+arr[3]+"</a><br/>";
		// 	}
		// 	str += arr[7] + "<br/>" + arr[8] + "<br/>";*/
		// 	str += "</div>";

		// 	return str;	
		// };



	</script>
</body>
</html>